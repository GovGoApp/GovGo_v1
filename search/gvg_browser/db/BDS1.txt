-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.categoria (
  id_categoria bigint NOT NULL DEFAULT nextval('categoria_id_categoria_seq'::regclass),
  cod_cat text NOT NULL UNIQUE,
  nom_cat text,
  cod_nv0 text,
  nom_nv0 text,
  cod_nv1 text,
  nom_nv1 text,
  cod_nv2 text,
  nom_nv2 text,
  cod_nv3 text,
  nom_nv3 text,
  cat_embeddings USER-DEFINED,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT categoria_pkey PRIMARY KEY (id_categoria)
);
CREATE TABLE public.contratacao (
  id_contratacao bigint NOT NULL DEFAULT nextval('contratacao_id_contratacao_seq'::regclass),
  numero_controle_pncp text UNIQUE,
  modo_disputa_id text,
  amparo_legal_codigo text,
  data_abertura_proposta text,
  data_encerramento_proposta text,
  srp text,
  orgao_entidade_cnpj text,
  orgao_entidade_razao_social text,
  orgao_entidade_poder_id text,
  orgao_entidade_esfera_id text,
  ano_compra text,
  sequencial_compra text,
  processo text,
  objeto_compra text,
  valor_total_homologado numeric,
  data_inclusao text,
  data_publicacao_pncp text,
  data_atualizacao text,
  numero_compra text,
  unidade_orgao_uf_nome text,
  unidade_orgao_uf_sigla text,
  unidade_orgao_municipio_nome text,
  unidade_orgao_codigo_unidade text,
  unidade_orgao_nome_unidade text,
  unidade_orgao_codigo_ibge text,
  modalidade_id text,
  data_atualizacao_global text,
  tipo_instrumento_convocatorio_codigo text,
  valor_total_estimado text,
  situacao_compra_id text,
  cod_cat text,
  score numeric,
  informacao_complementar text,
  justificativa_presencial text,
  link_sistema_origem text,
  link_processo_eletronico text,
  amparo_legal_nome text,
  amparo_legal_descricao text,
  modalidade_nome text,
  modo_disputa_nome text,
  tipo_instrumento_convocatorio_nome text,
  situacao_compra_nome text,
  existe_resultado boolean,
  orcamento_sigiloso_codigo integer,
  orcamento_sigiloso_descricao text,
  orgao_subrogado_cnpj text,
  orgao_subrogado_razao_social text,
  orgao_subrogado_poder_id text,
  orgao_subrogado_esfera_id text,
  unidade_subrogada_uf_nome text,
  unidade_subrogada_uf_sigla text,
  unidade_subrogada_municipio_nome text,
  unidade_subrogada_codigo_unidade text,
  unidade_subrogada_nome_unidade text,
  unidade_subrogada_codigo_ibge text,
  usuario_nome text,
  fontes_orcamentarias text,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT contratacao_pkey PRIMARY KEY (id_contratacao),
  CONSTRAINT contratacao_cod_cat_fkey FOREIGN KEY (cod_cat) REFERENCES public.categoria(cod_cat)
);
CREATE TABLE public.contratacao_emb (
  id_contratacao_emb bigint NOT NULL DEFAULT nextval('contratacao_emb_id_contratacao_emb_seq'::regclass),
  numero_controle_pncp text UNIQUE,
  modelo_embedding text,
  confidence numeric,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  top_categories ARRAY,
  top_similarities ARRAY,
  embeddings USER-DEFINED,
  CONSTRAINT contratacao_emb_pkey PRIMARY KEY (id_contratacao_emb)
);
CREATE TABLE public.contrato (
  id_contrato bigint NOT NULL DEFAULT nextval('contrato_id_contrato_seq'::regclass),
  numero_controle_pncp_compra text,
  numero_controle_pncp text,
  numero_contrato_empenho text,
  ano_contrato text,
  data_assinatura text,
  data_vigencia_inicio text,
  data_vigencia_fim text,
  ni_fornecedor text,
  tipo_pessoa text,
  sequencial_contrato text,
  processo text,
  nome_razao_social_fornecedor text,
  numero_parcelas text,
  numero_retificacao text,
  objeto_contrato text,
  valor_inicial numeric,
  valor_parcela numeric,
  valor_global numeric,
  data_atualizacao_global text,
  tipo_contrato_id text,
  tipo_contrato_nome text,
  orgao_entidade_cnpj text,
  orgao_entidade_razaosocial text,
  orgao_entidade_poder_id text,
  orgao_entidade_esfera_id text,
  categoria_processo_id text,
  categoria_processo_nome text,
  unidade_orgao_uf_nome text,
  unidade_orgao_codigo_unidade text,
  unidade_orgao_nome_unidade text,
  unidade_orgao_uf_sigla text,
  unidade_orgao_municipio_nome text,
  unidade_orgao_codigo_ibge text,
  vigencia_ano text,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT contrato_pkey PRIMARY KEY (id_contrato),
  CONSTRAINT contrato_numero_controle_pncp_fkey FOREIGN KEY (numero_controle_pncp) REFERENCES public.contratacao(numero_controle_pncp)
);
CREATE TABLE public.item_classificacao (
  id_item_classificacao bigint NOT NULL DEFAULT nextval('item_classificacao_id_item_classificacao_seq1'::regclass),
  numero_controle_pncp text,
  numero_item text,
  id_item text,
  descricao text,
  item_type text,
  top_1 text,
  top_2 text,
  top_3 text,
  top_4 text,
  top_5 text,
  score_1 numeric,
  score_2 numeric,
  score_3 numeric,
  score_4 numeric,
  score_5 numeric,
  confidence numeric,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT item_classificacao_pkey PRIMARY KEY (id_item_classificacao)
);
CREATE TABLE public.item_contratacao (
  id_item bigint NOT NULL DEFAULT nextval('item_contratacao_id_item_seq'::regclass),
  numero_controle_pncp text,
  numero_item text,
  descricao_item text,
  material_ou_servico text,
  valor_unitario_estimado numeric,
  valor_total_estimado numeric,
  quantidade_item numeric,
  unidade_medida text,
  item_categoria_id text,
  item_categoria_nome text,
  criterio_julgamento_id text,
  situacao_item text,
  tipo_beneficio text,
  data_inclusao text,
  data_atualizacao text,
  ncm_nbs_codigo text,
  catalogo text,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT item_contratacao_pkey PRIMARY KEY (id_item),
  CONSTRAINT item_contratacao_numero_controle_pncp_fkey FOREIGN KEY (numero_controle_pncp) REFERENCES public.contratacao(numero_controle_pncp)
);
CREATE TABLE public.system_config (
  key character varying NOT NULL,
  value text NOT NULL,
  description text,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT system_config_pkey PRIMARY KEY (key)
);
CREATE TABLE public.user_prompts (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  user_id uuid DEFAULT gen_random_uuid(),
  title text,
  text text,
  embedding USER-DEFINED,
  search_type smallint DEFAULT 1,
  search_approach smallint DEFAULT 3,
  relevance_level smallint DEFAULT 2,
  sort_mode smallint DEFAULT 1,
  max_results integer DEFAULT 30,
  top_categories_count integer DEFAULT 10,
  filter_expired boolean DEFAULT true,
  CONSTRAINT user_prompts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_results (
  id bigint NOT NULL DEFAULT nextval('user_results_id_seq'::regclass),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  user_id uuid NOT NULL,
  prompt_id bigint NOT NULL,
  numero_controle_pncp text NOT NULL,
  rank integer NOT NULL,
  similarity numeric,
  valor numeric,
  data_encerramento_proposta text,
  CONSTRAINT user_results_pkey PRIMARY KEY (id),
  CONSTRAINT user_results_numero_controle_fkey FOREIGN KEY (numero_controle_pncp) REFERENCES public.contratacao(numero_controle_pncp),
  CONSTRAINT user_results_prompt_fkey FOREIGN KEY (prompt_id) REFERENCES public.user_prompts(id)
);
CREATE TABLE public.user_settings (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text,
  CONSTRAINT user_settings_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.user_bookmarks (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  user_id TEXT NOT NULL,
  numero_controle_pncp TEXT NOT NULL
);

create table public.user_boletins (
  id bigserial not null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone not null default now(),
  user_id text not null,
  query_text text not null,
  schedule_type text not null,
  schedule_detail jsonb not null,
  channels jsonb not null,
  config_snapshot jsonb not null,
  next_run_at timestamp with time zone null,
  last_run_at timestamp with time zone null,
  active boolean not null default true,
  constraint user_boletins_pkey primary key (id),
  constraint user_boletins_schedule_type_check check (
    (
      schedule_type = any (
        array[
          'MULTIDIARIO'::text,
          'DIARIO'::text,
          'SEMANAL'::text
        ]
      )
    )
  )
) 

# ex. config_snapshot: {"sort_mode": 1, "max_results": 30, "search_type": 1, "filter_expired": true, "relevance_level": 2, "search_approach": 3, "top_categories_count": 10}
# ex. schedule_detail: {"slots": ["manha", "tarde", "noite"]}
# ex. channels: ["email", "whatsapp"]